<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>R-SANTA: Deluxe Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --red: #ff2244;
  --gold: #ffd700;
  --green: #2ecc71;
  --green2: #27ae60;
  --dark: #010c18;
  --dark2: #020e20;
  --surface: rgba(255,255,255,0.06);
  --surface2: rgba(255,255,255,0.12);
  --border: rgba(255,255,255,0.12);
  --text: #f0f4ff;
  --text-dim: rgba(255,255,255,0.5);
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; margin:0; padding:0; }
body { background:var(--dark); color:var(--text); font-family:'Nunito',sans-serif; overflow:hidden; touch-action:none; height:100vh; display:flex; flex-direction:column; }

/* SNOW */
#snowCanvas { position:fixed; top:0; left:0; pointer-events:none; z-index:1; }

/* LANG SCREEN */
#langScreen {
  position:fixed; inset:0; background:var(--dark);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  z-index:9000; gap:0;
}
.lang-logo {
  font-family:'Mountains of Christmas',cursive;
  font-size:3.2rem; font-weight:700;
  color:var(--gold);
  text-shadow:0 0 30px rgba(255,215,0,0.5), 0 0 60px rgba(255,215,0,0.2);
  margin-bottom:6px; letter-spacing:2px;
  animation:glow 2s ease-in-out infinite alternate;
}
@keyframes glow { from{text-shadow:0 0 20px rgba(255,215,0,0.4);} to{text-shadow:0 0 40px rgba(255,215,0,0.8),0 0 80px rgba(255,215,0,0.3);} }
.lang-sub { font-size:0.75rem; letter-spacing:5px; color:var(--text-dim); text-transform:uppercase; margin-bottom:50px; }
.lang-label { font-size:0.7rem; letter-spacing:4px; color:var(--text-dim); text-transform:uppercase; margin-bottom:18px; }
.lang-row { display:flex; gap:14px; margin-bottom:40px; }
.lang-btn {
  background:var(--surface); border:1px solid var(--border); color:var(--text);
  padding:14px 28px; font-family:'Nunito',sans-serif; font-size:1rem; font-weight:700;
  letter-spacing:2px; cursor:pointer; transition:all 0.2s; border-radius:16px;
}
.lang-btn .flag { display:block; font-size:1.6rem; margin-bottom:4px; text-align:center; }
.lang-btn:hover {
  border-color:var(--gold); color:var(--gold);
  background:rgba(255,215,0,0.08);
  box-shadow:0 0 20px rgba(255,215,0,0.2);
  transform:translateY(-3px);
}

/* TOP BAR */
#topBar {
  position:relative; z-index:100;
  display:none; justify-content:space-between; align-items:center;
  padding:14px 20px 8px;
  background:linear-gradient(to bottom, rgba(1,12,24,0.98), transparent);
}
.rc-panel {
  background:rgba(0,0,0,0.5); padding:8px 22px; border-radius:50px;
  border:1px solid rgba(255,215,0,0.4); font-size:1.3rem; font-weight:800;
  color:var(--gold); backdrop-filter:blur(10px);
  box-shadow:0 0 15px rgba(255,215,0,0.2);
  display:flex; align-items:center; gap:6px;
}
.top-right { display:flex; gap:8px; }
.icon-btn {
  background:rgba(0,0,0,0.4); border:1px solid var(--border);
  color:var(--text-dim); width:38px; height:38px; border-radius:50%;
  font-size:1rem; cursor:pointer; transition:all 0.2s;
  display:flex; align-items:center; justify-content:center;
}
.icon-btn:hover { border-color:var(--gold); color:var(--gold); }
.icon-btn.music-on { color:var(--gold); border-color:var(--gold); }

/* STAGE */
#stage {
  flex:1; display:flex; align-items:flex-end; justify-content:center;
  position:relative; z-index:5; overflow:hidden;
  padding-bottom:10px;
}
.tree-wrap { position:relative; display:inline-flex; align-items:flex-end; justify-content:center; }
.tree-svg { width:min(280px, 60vw); height:auto; filter:drop-shadow(0 0 30px rgba(46,204,113,0.4)); }

/* Lights twinkling on tree */
.tree-light { position:absolute; border-radius:50%; animation:twinkle 1.5s ease-in-out infinite alternate; }
@keyframes twinkle { from{opacity:0.3;transform:scale(0.8);} to{opacity:1;transform:scale(1.2);} }

.toy-on-tree {
  position:absolute; font-size:clamp(32px,8vw,52px);
  cursor:grab; z-index:100; user-select:none; touch-action:none;
  filter:drop-shadow(0 2px 8px rgba(0,0,0,0.5));
  transition:filter 0.2s;
}
.toy-on-tree:active { cursor:grabbing; filter:drop-shadow(0 4px 16px rgba(255,215,0,0.6)); }

/* NOTIFY */
#notifyPop {
  position:fixed; top:-160px; left:50%; transform:translateX(-50%);
  background:rgba(5,15,35,0.95); backdrop-filter:blur(20px);
  padding:18px 40px; border-radius:24px; border:1px solid rgba(255,215,0,0.5);
  transition:top 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
  z-index:7000; text-align:center; white-space:nowrap;
  box-shadow:0 8px 40px rgba(0,0,0,0.6), 0 0 30px rgba(255,215,0,0.15);
}
#notifyPop.active { top:80px; }
#notifyEmoji { font-size:2.8rem; display:block; margin-bottom:4px; }
#notifyText { font-size:0.85rem; font-weight:700; color:var(--gold); letter-spacing:3px; text-transform:uppercase; }

/* MENU */
#menu {
  position:relative; z-index:100;
  background:linear-gradient(to top, #000918, rgba(1,12,24,0.97));
  border-top:1px solid rgba(255,255,255,0.08);
  border-radius:28px 28px 0 0;
  padding:16px 16px 20px;
  display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
  box-shadow:0 -4px 40px rgba(0,0,0,0.5);
}
.btn {
  background:var(--surface); border:1px solid var(--border);
  color:var(--text); border-radius:18px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; transition:all 0.18s; padding:14px 8px; gap:4px;
}
.btn-icon { font-size:clamp(24px,6vw,36px); }
.btn-label { font-size:0.68rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--text-dim); }
.btn:active { transform:scale(0.9); }
.btn:hover { border-color:rgba(255,255,255,0.25); background:var(--surface2); }
.btn-gift {
  background:linear-gradient(135deg, #ff3355, #c0132b) !important;
  border-color:rgba(255,80,80,0.5) !important;
  animation:pulsebtn 1.8s infinite;
  box-shadow:0 0 20px rgba(255,34,68,0.3);
}
.btn-gift .btn-label { color:rgba(255,255,255,0.8) !important; }
@keyframes pulsebtn { 0%,100%{box-shadow:0 0 15px rgba(255,34,68,0.3);} 50%{box-shadow:0 0 30px rgba(255,34,68,0.6);} }

/* MODAL */
.modal {
  position:fixed; inset:0; background:rgba(0,5,15,0.98);
  z-index:5000; display:none; flex-direction:column;
  padding:0; overflow:hidden;
}
.modal.open { display:flex; animation:modalIn 0.3s ease; }
@keyframes modalIn { from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);} }
.modal-header {
  padding:20px 20px 14px; display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--border); flex-shrink:0;
}
.modal-title { font-family:'Mountains of Christmas',cursive; font-size:1.8rem; font-weight:700; }
.close-btn {
  width:40px; height:40px; border-radius:50%; background:rgba(255,34,68,0.15);
  border:1px solid rgba(255,34,68,0.3); color:var(--red); font-size:1.4rem;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:all 0.2s;
}
.close-btn:hover { background:rgba(255,34,68,0.3); }
.modal-body { overflow-y:auto; padding:16px; flex:1; }
.grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
.card {
  background:#060f1e; padding:16px 12px; border-radius:16px;
  text-align:center; border:1px solid rgba(255,255,255,0.07);
  transition:border-color 0.2s;
}
.card:hover { border-color:rgba(255,215,0,0.3); }
.card-emoji { font-size:clamp(40px,10vw,56px); display:block; margin:8px 0; }
.card-name { font-size:0.75rem; color:var(--text-dim); margin-bottom:6px; }
.card-price { font-size:1rem; font-weight:800; color:var(--gold); margin-bottom:10px; }
.buy-btn {
  width:100%; border:none; background:linear-gradient(135deg,var(--gold),#e6b800);
  padding:10px; border-radius:10px; font-weight:800; cursor:pointer; color:#000;
  font-family:'Nunito',sans-serif; font-size:0.9rem; letter-spacing:1px;
  transition:all 0.2s;
}
.buy-btn:hover { transform:scale(1.03); box-shadow:0 4px 15px rgba(255,215,0,0.3); }
.buy-btn:disabled { background:#333; color:#666; cursor:not-allowed; transform:none; }
.chest-card { cursor:pointer; }
.chest-card:active { transform:scale(0.95); }
.owned-badge { font-size:0.65rem; color:var(--green); letter-spacing:2px; margin-bottom:8px; }

/* STARS BG */
.star { position:fixed; border-radius:50%; background:white; animation:startwinkle 3s ease-in-out infinite alternate; pointer-events:none; z-index:0; }
@keyframes startwinkle { from{opacity:0.1;}to{opacity:0.7;} }
</style>
</head>
<body>

<canvas id="snowCanvas"></canvas>

<!-- ======= LANG SCREEN ======= -->
<div id="langScreen">
  <div class="lang-logo">&#127877; R-SANTA</div>
  <div class="lang-sub">Deluxe Edition</div>
  <div class="lang-label">Select Language / Tilni tanlang / &#1042;&#1099;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#1103;&#1079;&#1099;&#1082;</div>
  <div class="lang-row">
    <button class="lang-btn" onclick="selectLang('uz')">
      <span class="flag">&#127482;&#127487;</span>UZ
    </button>
    <button class="lang-btn" onclick="selectLang('ru')">
      <span class="flag">&#127479;&#127482;</span>RU
    </button>
    <button class="lang-btn" onclick="selectLang('en')">
      <span class="flag">&#127468;&#127463;</span>EN
    </button>
  </div>
</div>

<!-- ======= TOP BAR ======= -->
<div id="topBar">
  <div class="rc-panel">&#128176; <span id="rcVal">100</span> RC</div>
  <div class="top-right">
    <button class="icon-btn" id="musicBtn" onclick="toggleMusic()" title="Music">&#127925;</button>
    <button class="icon-btn" onclick="changeLang()" title="Language">&#127760;</button>
  </div>
</div>

<!-- ======= STAGE ======= -->
<div id="stage">
  <div class="tree-wrap" id="treeWrap">
    <svg class="tree-svg" viewBox="0 0 200 265" xmlns="http://www.w3.org/2000/svg">
      <!-- Snowflakes on tree -->
      <polygon points="100,8 175,108 25,108" fill="#2ecc71"/>
      <polygon points="100,8 175,108 25,108" fill="url(#treeGrad1)"/>
      <polygon points="100,55 185,168 15,168" fill="#27ae60"/>
      <polygon points="100,55 185,168 15,168" fill="url(#treeGrad2)" opacity="0.4"/>
      <polygon points="100,105 198,242 2,242" fill="#1e8449"/>
      <polygon points="100,105 198,242 2,242" fill="url(#treeGrad3)" opacity="0.4"/>
      <rect x="84" y="242" width="32" height="22" rx="4" fill="#6d4c41"/>
      <rect x="84" y="242" width="32" height="22" rx="4" fill="url(#trunkGrad)" opacity="0.5"/>
      <!-- Star on top -->
      <polygon points="100,2 103,9 111,9 105,14 107,22 100,17 93,22 95,14 89,9 97,9" fill="#ffd700" filter="url(#starGlow)"/>
      <!-- Decorative lights hint -->
      <circle cx="70" cy="90" r="3" fill="#ff4444" opacity="0.8"/>
      <circle cx="130" cy="95" r="3" fill="#4444ff" opacity="0.8"/>
      <circle cx="55" cy="140" r="3" fill="#ffff44" opacity="0.8"/>
      <circle cx="145" cy="130" r="3" fill="#ff44ff" opacity="0.8"/>
      <circle cx="80" cy="175" r="3" fill="#44ffff" opacity="0.8"/>
      <circle cx="120" cy="180" r="3" fill="#ff8844" opacity="0.8"/>
      <circle cx="60" cy="200" r="3" fill="#88ff44" opacity="0.8"/>
      <circle cx="140" cy="195" r="3" fill="#ff4488" opacity="0.8"/>
      <circle cx="100" cy="165" r="3" fill="#ffd700" opacity="0.8"/>
      <defs>
        <linearGradient id="treeGrad1" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#4ade80" stop-opacity="0.3"/><stop offset="1" stop-color="#166534" stop-opacity="0"/></linearGradient>
        <linearGradient id="treeGrad2" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#4ade80" stop-opacity="0.3"/><stop offset="1" stop-color="#166534" stop-opacity="0"/></linearGradient>
        <linearGradient id="treeGrad3" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#4ade80" stop-opacity="0.2"/><stop offset="1" stop-color="#166534" stop-opacity="0"/></linearGradient>
        <linearGradient id="trunkGrad" x1="0" y1="0" x2="1" y2="0"><stop offset="0" stop-color="#fff" stop-opacity="0.3"/><stop offset="1" stop-color="#000" stop-opacity="0.3"/></linearGradient>
        <filter id="starGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
    </svg>
  </div>
</div>

<!-- ======= MENU ======= -->
<div id="menu">
  <button class="btn" onclick="openModal('shop')">
    <span class="btn-icon">&#127857;</span>
    <span class="btn-label" id="btnShop">SHOP</span>
  </button>
  <button class="btn" onclick="openModal('chest')">
    <span class="btn-icon">&#128218;</span>
    <span class="btn-label" id="btnChest">CHEST</span>
  </button>
  <button class="btn btn-gift" onclick="getGift()">
    <span class="btn-icon">&#127873;</span>
    <span class="btn-label" id="btnGift">GIFT</span>
  </button>
  <button class="btn" onclick="clearTree()">
    <span class="btn-icon">&#10060;</span>
    <span class="btn-label" id="btnClear">CLEAR</span>
  </button>
</div>

<!-- ======= NOTIFY ======= -->
<div id="notifyPop">
  <span id="notifyEmoji">&#127877;</span>
  <div id="notifyText">GIFT COLLECTED!</div>
</div>

<!-- ======= MODAL: SHOP ======= -->
<div id="modalShop" class="modal">
  <div class="modal-header">
    <div class="modal-title" style="color:var(--gold)">&#127857; <span id="shopTitle">Christmas Market</span></div>
    <button class="close-btn" onclick="closeModal()">&#10005;</button>
  </div>
  <div class="modal-body">
    <div class="grid" id="shopList"></div>
  </div>
</div>

<!-- ======= MODAL: CHEST ======= -->
<div id="modalChest" class="modal">
  <div class="modal-header">
    <div class="modal-title" style="color:var(--green)">&#127760; <span id="chestTitle">My Decorations</span></div>
    <button class="close-btn" onclick="closeModal()">&#10005;</button>
  </div>
  <div class="modal-body">
    <div class="grid" id="chestList"></div>
  </div>
</div>

<script>
// ============================================================
// TRANSLATIONS
// ============================================================
var T = {
  uz: {
    shopTitle: "Xristmas Bozori",
    chestTitle: "Mening Bezaklarim",
    btnShop: "DO'KON",
    btnChest: "SANDIQ",
    btnGift: "SOVG'A",
    btnClear: "TOZALASH",
    buyBtn: "SOTIB OL",
    addBtn: "QO'SH",
    notEnough: "RC yetarli emas!",
    purchased: "SOTIB OLINDI!",
    giftMsg: "HO-HO-HO! +10 RC",
    clearMsg: "ARCHA TOZALANDI!",
    rcLabel: "RC",
    musicOn: "ON",
    musicOff: "OFF"
  },
  ru: {
    shopTitle: "\u0420\u043e\u0436\u0434\u0435\u0441\u0442\u0432\u0435\u043d\u0441\u043a\u0438\u0439 \u0420\u044b\u043d\u043e\u043a",
    chestTitle: "\u041c\u043e\u0438 \u0423\u043a\u0440\u0430\u0448\u0435\u043d\u0438\u044f",
    btnShop: "\u041c\u0410\u0413\u0410\u0417\u0418\u041d",
    btnChest: "\u0421\u0423\u041d\u0414\u0423\u041a",
    btnGift: "\u041f\u041e\u0414\u0410\u0420\u041e\u041a",
    btnClear: "\u041e\u0427\u0418\u0421\u0422\u0418\u0422\u042c",
    buyBtn: "\u041a\u0423\u041f\u0418\u0422\u042c",
    addBtn: "\u0414\u041e\u0411\u0410\u0412\u0418\u0422\u042c",
    notEnough: "\u041d\u0435 \u0445\u0432\u0430\u0442\u0430\u0435\u0442 RC!",
    purchased: "\u041a\u0423\u041f\u041b\u0415\u041d\u041e!",
    giftMsg: "\u0425\u041e-\u0425\u041e-\u0425\u041e! +10 RC",
    clearMsg: "\u0415\u041b\u041a\u0410 \u041e\u0427\u0418\u0429\u0415\u041d\u0410!",
    rcLabel: "RC",
    musicOn: "\u0412\u041a\u041b",
    musicOff: "\u0412\u042b\u041a\u041b"
  },
  en: {
    shopTitle: "Christmas Market",
    chestTitle: "My Decorations",
    btnShop: "SHOP",
    btnChest: "CHEST",
    btnGift: "GIFT",
    btnClear: "CLEAR",
    buyBtn: "BUY",
    addBtn: "ADD",
    notEnough: "Not enough RC!",
    purchased: "PURCHASED!",
    giftMsg: "HO-HO-HO! +10 RC",
    clearMsg: "TREE CLEARED!",
    rcLabel: "RC",
    musicOn: "ON",
    musicOff: "OFF"
  }
};

// ============================================================
// SHOP ITEMS
// ============================================================
var shopItems = [
  {e:'\uD83D\uDD34', name:{uz:'Qizil shar',ru:'\u041a\u0440\u0430\u0441\u043d\u044b\u0439 \u0448\u0430\u0440',en:'Red Ball'}, p:20},
  {e:'\uD83D\uDD35', name:{uz:'Ko\'k shar',ru:'\u0421\u0438\u043d\u0438\u0439 \u0448\u0430\u0440',en:'Blue Ball'}, p:20},
  {e:'\uD83D\uDFE1', name:{uz:'Sariq shar',ru:'\u0416\u0451\u043b\u0442\u044b\u0439 \u0448\u0430\u0440',en:'Yellow Ball'}, p:20},
  {e:'\uD83D\uDFE2', name:{uz:'Yashil shar',ru:'\u0417\u0435\u043b\u0451\u043d\u044b\u0439 \u0448\u0430\u0440',en:'Green Ball'}, p:20},
  {e:'\uD83D\uDD14', name:{uz:'Qo\'ng\'iroq',ru:'\u041a\u043e\u043b\u043e\u043a\u043e\u043b\u044c\u0447\u0438\u043a',en:'Bell'}, p:50},
  {e:'\uD83C\uDF6D', name:{uz:'Karamel',ru:'\u041a\u0430\u0440\u0430\u043c\u0435\u043b\u044c',en:'Candy Cane'}, p:40},
  {e:'\u2744\uFE0F', name:{uz:'Qor uchquni',ru:'\u0421\u043d\u0435\u0436\u0438\u043d\u043a\u0430',en:'Snowflake'}, p:60},
  {e:'\uD83C\uDF1F', name:{uz:'Yulduz',ru:'\u0417\u0432\u0435\u0437\u0434\u043e\u0447\u043a\u0430',en:'Star'}, p:100},
  {e:'\uD83E\uDD8C', name:{uz:'Zigirqush',ru:'\u041e\u043b\u0435\u043d\u044c',en:'Deer'}, p:80},
  {e:'\uD83C\uDF6A', name:{uz:'Keks',ru:'\u041f\u0435\u0447\u0435\u043d\u044c\u0435',en:'Cookie'}, p:45},
  {e:'\uD83C\uDF81', name:{uz:'Sovg\'a qutisi',ru:'\u041f\u043e\u0434\u0430\u0440\u043e\u043a',en:'Gift Box'}, p:150},
  {e:'\uD83E\uDD8C', name:{uz:'Bug\'u',ru:'\u0421\u0435\u0432\u0435\u0440\u043d\u044b\u0439 \u043e\u043b\u0435\u043d\u044c',en:'Reindeer'}, p:120},
  {e:'\u26C4', name:{uz:'Qo\'g\'irchoq',ru:'\u0421\u043d\u0435\u0433\u043e\u0432\u0438\u043a',en:'Snowman'}, p:250},
  {e:'\uD83C\uDF84', name:{uz:'Archa',ru:'\u0415\u043b\u043a\u0430',en:'Xmas Tree'}, p:400},
  {e:'\uD83D\uDD6F\uFE0F', name:{uz:'Sham',ru:'\u0421\u0432\u0435\u0447\u0430',en:'Candle'}, p:90},
  {e:'\u2728', name:{uz:'Yaltiroq',ru:'\u0411\u043b\u0451\u0441\u0442\u043a\u0438',en:'Sparkles'}, p:120},
  {e:'\uD83C\uDF80', name:{uz:'Tasmali',ru:'\u0411\u0430\u043d\u0442',en:'Ribbon'}, p:70},
  {e:'\uD83D\uDC8E', name:{uz:'Javohir',ru:'\u0414\u0440\u0430\u0433\u043e\u0446\u0435\u043d\u043d\u044b\u0439 \u043a\u0430\u043c\u0435\u043d\u044c',en:'Gem'}, p:1000}
];

// ============================================================
// STATE
// ============================================================
var lang = 'en';
var db = { rc: 100, inventory: ['\u2B50'] };
var musicOn = false;
var audioCtx = null;
var musicTimeout = null;

// ============================================================
// LANGUAGE
// ============================================================
function selectLang(l) {
  lang = l;
  initAudio();
  resumeAudio();
  sfxNav();
  applyLang();
  document.getElementById('langScreen').style.display = 'none';
  document.getElementById('topBar').style.display = 'flex';
  setTimeout(function() { if(musicOn) playMelody(); }, 200);
}

function changeLang() {
  sfxNav();
  document.getElementById('langScreen').style.display = 'flex';
  document.getElementById('topBar').style.display = 'none';
}

function applyLang() {
  var t = T[lang];
  document.getElementById('shopTitle').textContent = t.shopTitle;
  document.getElementById('chestTitle').textContent = t.chestTitle;
  document.getElementById('btnShop').textContent = t.btnShop;
  document.getElementById('btnChest').textContent = t.btnChest;
  document.getElementById('btnGift').textContent = t.btnGift;
  document.getElementById('btnClear').textContent = t.btnClear;
}

// ============================================================
// AUDIO ENGINE
// ============================================================
function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function resumeAudio() { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }

function playTone(freq, dur, startTime, vol, type) {
  if (!audioCtx) return;
  vol = vol || 0.12; type = type || 'sine';
  var t = audioCtx.currentTime + (startTime || 0);
  var osc = audioCtx.createOscillator();
  var g = audioCtx.createGain();
  osc.type = type; osc.frequency.value = freq;
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(vol, t + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur + 0.05);
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(t); osc.stop(t + dur + 0.1);
}

function sfxNav() {
  if (!audioCtx) return;
  playTone(660, 0.08, 0, 0.1, 'sine');
  playTone(880, 0.08, 0.07, 0.08, 'sine');
}

function sfxBuy() {
  if (!audioCtx) return;
  [523, 659, 784].forEach(function(f, i) { playTone(f, 0.1, i * 0.08, 0.12, 'sine'); });
}

function sfxGift() {
  if (!audioCtx) return;
  [392, 523, 659, 784, 1047].forEach(function(f, i) {
    playTone(f, 0.12, i * 0.07, 0.15, 'triangle');
  });
}

function sfxPlace() {
  if (!audioCtx) return;
  playTone(880, 0.06, 0, 0.1, 'sine');
  playTone(1100, 0.08, 0.06, 0.08, 'sine');
}

function sfxClear() {
  if (!audioCtx) return;
  [523, 440, 330].forEach(function(f, i) { playTone(f, 0.1, i * 0.07, 0.1, 'triangle'); });
}

// JINGLE BELLS melody
var jingle = [
  {f:659,d:0.25},{f:659,d:0.25},{f:659,d:0.5},
  {f:659,d:0.25},{f:659,d:0.25},{f:659,d:0.5},
  {f:659,d:0.25},{f:783,d:0.25},{f:523,d:0.25},{f:587,d:0.25},{f:659,d:0.8},
  {f:698,d:0.25},{f:698,d:0.25},{f:698,d:0.35},{f:698,d:0.15},
  {f:698,d:0.25},{f:659,d:0.25},{f:659,d:0.15},{f:659,d:0.15},
  {f:659,d:0.2},{f:587,d:0.2},{f:587,d:0.2},{f:659,d:0.2},{f:587,d:0.3},{f:698,d:0.3},
  {f:783,d:0.7},{f:0,d:0.2},
  {f:659,d:0.25},{f:659,d:0.25},{f:659,d:0.5},
  {f:659,d:0.25},{f:659,d:0.25},{f:659,d:0.5},
  {f:659,d:0.25},{f:783,d:0.25},{f:523,d:0.25},{f:587,d:0.25},{f:659,d:0.8},
  {f:783,d:0.25},{f:783,d:0.25},{f:783,d:0.25},{f:783,d:0.25},
  {f:783,d:0.25},{f:698,d:0.25},{f:587,d:0.25},{f:523,d:0.6}
];

function playMelody() {
  if (!musicOn || !audioCtx) return;
  var time = 0;
  jingle.forEach(function(n) {
    if (n.f > 0) playTone(n.f, n.d + 0.15, time, 0.1, 'triangle');
    // Harmony
    if (n.f > 0) playTone(n.f * 1.5, n.d + 0.1, time, 0.04, 'sine');
    time += n.d + 0.04;
  });
  musicTimeout = setTimeout(function() { if (musicOn) playMelody(); }, time * 1000 + 800);
}

function toggleMusic() {
  initAudio(); resumeAudio();
  musicOn = !musicOn;
  var btn = document.getElementById('musicBtn');
  btn.classList.toggle('music-on', musicOn);
  btn.innerHTML = musicOn ? '&#128266;' : '&#128263;';
  if (musicOn) { playMelody(); }
  else { clearTimeout(musicTimeout); }
}

// ============================================================
// GAME LOGIC
// ============================================================
function updateRC() { document.getElementById('rcVal').textContent = db.rc; }

function notify(emoji, text) {
  var pop = document.getElementById('notifyPop');
  document.getElementById('notifyEmoji').textContent = emoji;
  document.getElementById('notifyText').textContent = text;
  pop.classList.add('active');
  setTimeout(function() { pop.classList.remove('active'); }, 2600);
}

function getGift() {
  initAudio(); resumeAudio();
  db.rc += 10;
  updateRC();
  sfxGift();
  notify('\uD83C\uDF85', T[lang].giftMsg);
  // Animate tree lights
  var lights = document.querySelectorAll('.tree-svg circle');
  lights.forEach(function(l) {
    l.style.transition = 'opacity 0.2s';
    l.style.opacity = '1';
    setTimeout(function() { l.style.opacity = '0.8'; }, 300);
  });
}

function clearTree() {
  initAudio(); resumeAudio();
  var toys = document.querySelectorAll('.toy-on-tree');
  toys.forEach(function(t) { t.remove(); });
  sfxClear();
  notify('\uD83C\uDF84', T[lang].clearMsg);
}

function openModal(id) {
  initAudio(); resumeAudio(); sfxNav();
  var m = document.getElementById('modal' + id.charAt(0).toUpperCase() + id.slice(1));
  m.classList.add('open');
  renderModal(id);
}

function closeModal() {
  sfxNav();
  document.querySelectorAll('.modal').forEach(function(m) { m.classList.remove('open'); });
}

function renderModal(id) {
  var t = T[lang];
  if (id === 'shop') {
    var html = '';
    shopItems.forEach(function(item) {
      var canAfford = db.rc >= item.p;
      var alreadyOwned = db.inventory.indexOf(item.e) >= 0;
      html += '<div class="card">' +
        '<span class="card-emoji">' + item.e + '</span>' +
        '<div class="card-name">' + (item.name[lang] || item.name.en) + '</div>' +
        '<div class="card-price">' + item.p + ' RC</div>' +
        (alreadyOwned
          ? '<div class="owned-badge">&#10003; OWNED</div>'
          : '<button class="buy-btn" ' + (!canAfford ? 'disabled' : '') + ' onclick="buy(\'' + encodeURIComponent(item.e) + '\',' + item.p + ')">' + t.buyBtn + '</button>'
        ) +
        '</div>';
    });
    document.getElementById('shopList').innerHTML = html;
  } else {
    var html2 = '';
    db.inventory.forEach(function(e) {
      html2 += '<div class="card chest-card" onclick="placeToy(\'' + encodeURIComponent(e) + '\')">' +
        '<span class="card-emoji">' + e + '</span>' +
        '<div class="owned-badge">&#128449; ' + t.addBtn + '</div>' +
        '</div>';
    });
    document.getElementById('chestList').innerHTML = html2;
  }
}

function buy(encodedE, p) {
  var e = decodeURIComponent(encodedE);
  if (db.rc < p) { notify('\u26A0\uFE0F', T[lang].notEnough); return; }
  db.rc -= p;
  if (db.inventory.indexOf(e) < 0) db.inventory.push(e);
  updateRC();
  sfxBuy();
  closeModal();
  notify(e, T[lang].purchased);
}

function placeToy(encodedE) {
  var e = decodeURIComponent(encodedE);
  var toy = document.createElement('div');
  toy.className = 'toy-on-tree';
  toy.textContent = e;

  // Place near center of tree
  var stage = document.getElementById('stage');
  var stageRect = stage.getBoundingClientRect();
  toy.style.left = (stageRect.width / 2 - 26 + (Math.random()-0.5)*60) + 'px';
  toy.style.top = (stageRect.height * 0.35 + (Math.random()-0.5)*40) + 'px';

  var isDragging = false;
  var offX = 0, offY = 0;

  function startDrag(cx, cy) {
    isDragging = true;
    var r = toy.getBoundingClientRect();
    offX = cx - r.left; offY = cy - r.top;
  }
  function doDrag(cx, cy) {
    if (!isDragging) return;
    var sr = stage.getBoundingClientRect();
    toy.style.left = (cx - sr.left - offX) + 'px';
    toy.style.top  = (cy - sr.top  - offY) + 'px';
  }
  function endDrag() { isDragging = false; }

  toy.addEventListener('mousedown', function(e2) { e2.preventDefault(); startDrag(e2.clientX, e2.clientY); });
  toy.addEventListener('touchstart', function(e2) { e2.preventDefault(); startDrag(e2.touches[0].clientX, e2.touches[0].clientY); }, {passive:false});
  window.addEventListener('mousemove', function(e2) { doDrag(e2.clientX, e2.clientY); });
  window.addEventListener('touchmove', function(e2) { if(isDragging){e2.preventDefault();doDrag(e2.touches[0].clientX,e2.touches[0].clientY);} }, {passive:false});
  window.addEventListener('mouseup', endDrag);
  window.addEventListener('touchend', endDrag);

  stage.appendChild(toy);
  sfxPlace();
  closeModal();
}

// ============================================================
// SNOW
// ============================================================
var canvas = document.getElementById('snowCanvas');
var ctx = canvas.getContext('2d');
var flakes = [];

function initSnow() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  flakes = [];
  for (var i = 0; i < 90; i++) {
    flakes.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 3 + 1,
      s: Math.random() * 1.5 + 0.5,
      w: Math.random() * 2 - 1,
      o: Math.random() * 0.5 + 0.3
    });
  }
}

function drawSnow() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  flakes.forEach(function(f) {
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255,255,255,' + f.o + ')';
    ctx.fill();
    f.y += f.s;
    f.x += f.w * 0.3;
    if (f.y > canvas.height) { f.y = -5; f.x = Math.random() * canvas.width; }
    if (f.x > canvas.width) f.x = 0;
    if (f.x < 0) f.x = canvas.width;
  });
  requestAnimationFrame(drawSnow);
}

// STARS
function createStars() {
  for (var i = 0; i < 40; i++) {
    var star = document.createElement('div');
    star.className = 'star';
    var size = Math.random() * 2 + 1;
    star.style.cssText = 'width:' + size + 'px;height:' + size + 'px;left:' + Math.random()*100 + '%;top:' + Math.random()*60 + '%;animation-delay:' + Math.random()*3 + 's;animation-duration:' + (2+Math.random()*2) + 's;';
    document.body.appendChild(star);
  }
}

window.addEventListener('resize', initSnow);
initSnow();
drawSnow();
createStars();
updateRC();
</script>
</body>
</html>
